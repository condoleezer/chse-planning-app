<div class="dashboard-container p-4 md:p-6">
  <p-toast></p-toast>
  <p class="dashboard-title text-2xl md:text-3xl font-bold mb-6">Configurations</p>

  <p-tabView (onChange)="onTabChange($event)">
      <p-tabPanel>
        <ng-template pTemplate="header">
          <button class="tab-button bg-blue-500 text-white hover:bg-blue-600">Gestion des services</button>
        </ng-template>
        <div class="flex justify-end py-5">
          <p-drawer [(visible)]="serviceVisible" position="right" [header]="isEditMode ? 'Modifier un service' : 'Ajouter un service'">
            <form [formGroup]="serviceForm" class="flex flex-col gap-2">
              <p-iftalabel>
                <input pInputText id="name" autocomplete="off" formControlName="name" class="uniform-input"/>
                <label for="name">Nom</label>
              </p-iftalabel>
              <div class="h-5"></div>
              <p-iftalabel>
                <p-select formControlName="head" [options]="cadreUsers" [filter]="true" optionLabel="first_name" placeholder="Sélectionner un responsable" class="w-full md:w-56 uniform-input"/>
                <label for="name">Responsable</label>
              </p-iftalabel>
              <p-button (click)="isEditMode ? updateService() : onSubmit()" severity="contrast" [disabled]="loading()" class="mt-5">
                {{ isEditMode ? 'Mettre à jour' : 'Créer un nouveau service' }}
              </p-button>
            </form>
          </p-drawer>
          <!--<p-button icon="pi pi-upload" (click)="showUploadDialog('service')" severity="secondary" styleClass="mr-2"></p-button>-->
          <p-button (click)="showAddDialog()" severity="contrast">Ajouter un Service</p-button>
        </div>
        
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <span class="p-input-icon-left w-full">
              <input pInputText type="text" [(ngModel)]="searchTermService" 
                     (input)="applyFilter()" 
                     placeholder="  Rechercher par matricule, médecin, pôle ou salle..."
                     class="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11">
            </span>
          </div>
        </div>
        
        <div class="table-container overflow-x-auto" style="border-radius: 0.75rem;">
          <p-table [value]="filteredService" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords" [lazy]="false" (onPage)="onPageChange($event)" [tableStyle]="{ 'min-width': '100%' }" responsiveLayout="scroll" class="w-full">
            <ng-template pTemplate="header">
              <tr>
                <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Matricule</th>
                <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Nom</th>
                <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Responsable</th>
                <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-service>
              <tr class="table-row hover:bg-gray-50">
                <td class="p-3 border-b">{{ service.matricule }}</td>
                <td class="p-3 border-b">{{ service.name }}</td>
                <td class="p-3 border-b">{{ service.head }}</td>
                <td class="space-x-3">
                  <i class="pi pi-pencil cursor-pointer text-blue-500 hover:text-blue-700" (click)="showEditDialog(service)"></i>
                  <i class="pi pi-trash cursor-pointer text-red-500 hover:text-red-700" (click)="confirmDelete(service)"></i>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <!--<div class="card flex justify-end mt-5">
          <p-paginator (onPageChange)="onPageChange($event)" [first]="first" [rows]="rows" [totalRecords]="totalRecords" [rowsPerPageOptions]="[10, 20, 30]" />
        </div>-->
      </p-tabPanel>

        <p-tabPanel>
          <ng-template pTemplate="header">
            <button class="tab-button bg-blue-500 text-white hover:bg-blue-600">Gestion des codes d'absences</button>
          </ng-template>
          <div class="flex justify-end py-5">
            <p-drawer [(visible)]="codeVisible" position="right" [header]="isEditMode ? 'Modifier un code absence' : 'Ajouter un code absence '">
              <form [formGroup]="codeForm" class="flex flex-col gap-2">
                <p-iftalabel>
                  <input pInputText id="name" autocomplete="off" formControlName="name" class="uniform-input"/>
                  <label for="name">Nom</label>
                </p-iftalabel>
                <div class="h-5"></div>
                <p-iftalabel>
                  <input pInputText id="name_abrege" autocomplete="off" formControlName="name_abrege" class="uniform-input"/>
                  <label for="name">Nom Abrégé</label>
                </p-iftalabel>
                <div class="h-5"></div>
                <p-iftalabel>
                  <input pInputText id="regroupement" autocomplete="off" formControlName="regroupement" class="uniform-input"/>
                  <label for="name">Regroupement</label>
                </p-iftalabel>
                <div class="h-5"></div>
                <p-iftalabel>
                  <p-datePicker  [style]="{ width: '100%' }" [inputStyle]="{ width: '100%' }" formControlName="begin_date" dateFormat="dd/mm/yy" [showIcon]="true" class="uniform-input w-full" placeholder="Sélectionnez une date"></p-datePicker>
                  <label for="name">Date de début</label>
                </p-iftalabel>
                <div class="h-5"></div>
                <p-iftalabel>
                  <p-datePicker  [style]="{ width: '100%' }" [inputStyle]="{ width: '100%' }" formControlName="end_date" dateFormat="dd/mm/yy" [showIcon]="true" class="uniform-input w-full" placeholder="Sélectionnez une date"></p-datePicker>
                  <label for="name">Date de fin</label>
                </p-iftalabel>
                <div class="h-5"></div>
                <p-iftalabel>
                  <textarea pInputText id="indicator" autocomplete="off" formControlName="indicator" class="uniform-input"></textarea>
                  <label for="name">Indicateur</label>
                </p-iftalabel>
                <div class="h-2"></div>
                <p-button (click)="isEditMode ? updateCodes() : onSubmitCode()" severity="contrast" [disabled]="loading()" class="mt-5">
                  {{ isEditMode ? 'Mettre à jour' : 'Ajouter un code absence' }}
                </p-button>
              </form>
            </p-drawer>
            <!--<p-button icon="pi pi-upload" (click)="showUploadDialog('room')" severity="secondary" styleClass="mr-2"></p-button>-->
            <p-button (click)="showAddDialogCode()" severity="contrast">Ajouter un code d'absence </p-button>
          </div>
          
          <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
              <span class="p-input-icon-left w-full">
                <input pInputText type="text" [(ngModel)]="searchTermCode" 
                       (input)="applyFilter()" 
                       placeholder="  Rechercher par matricule, médecin, pôle ou salle..."
                       class="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11">
              </span>
            </div>
          </div>

          <div class="table-container overflow-x-auto" style="border-radius: 0.75rem;">
            <p-table [value]="filteredCode" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords" [lazy]="false" (onPage)="onPageChange($event)" [tableStyle]="{ 'min-width': '100%' }" responsiveLayout="scroll" class="w-full">
              <ng-template pTemplate="header">
                <tr>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Nom abrégé</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Nom</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Regroupement</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Date de début</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Date de fin</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Actions</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rooms>
                <tr class="table-row hover:bg-gray-50">
                  <td class="p-3 border-b">{{ rooms.name_abrege }}</td>
                  <td class="p-3 border-b">{{ rooms.name }}</td>
                  <td class="p-3 border-b">{{ rooms.regroupement }}</td>
                  <td class="p-3 border-b">{{ formatDate(rooms.begin_date) }}</td>
                  <td class="p-3 border-b">{{ formatDate(rooms.end_date) }}</td>
                  <td class="space-x-3">
                    <i class="pi pi-pencil cursor-pointer text-blue-500 hover:text-blue-700" (click)="showEditDialogCode(rooms)"></i>
                    <i class="pi pi-trash cursor-pointer text-red-500 hover:text-red-700" (click)="confirmDeleteCode(rooms)"></i>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
          <!--<div class="card flex justify-end mt-5">
            <p-paginator (onPageChange)="onPageChange($event)" [first]="first" [rows]="rows" [totalRecords]="totalRecords" [rowsPerPageOptions]="[10, 20, 30]" />
          </div>-->
        </p-tabPanel>

        <p-tabPanel>
          <ng-template pTemplate="header">
            <button class="tab-button bg-blue-500 text-white hover:bg-blue-600">Gestion des compétences</button>
          </ng-template>
          <div class="flex justify-end py-5">
            <p-drawer [(visible)]="specialityVisible" position="right" [header]="isEditMode ? 'Modifier une compétence' : 'Ajouter une compétence'">
              <form [formGroup]="specialityForm" class="flex flex-col gap-2">
                <p-iftalabel>
                  <input pInputText id="name" autocomplete="off" formControlName="name" class="uniform-input"/>
                  <label for="name">Nom</label>
                </p-iftalabel>
                <p-button (click)="isEditMode ? updateSpeciality() : onSubmitSpeciality()" severity="contrast" [disabled]="loading()" class="mt-5">
                  {{ isEditMode ? 'Mettre à jour' : 'Ajouter une compétence' }}
                </p-button>
              </form>
            </p-drawer>
            <!--<p-button icon="pi pi-upload" (click)="showUploadDialog('speciality')" severity="secondary" styleClass="mr-2"></p-button>-->
            <p-button (click)="showAddDialogSpeciality()" severity="contrast">Ajouter une compétence</p-button>
          </div>
          
          <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
              <span class="p-input-icon-left w-full">
                <input pInputText type="text" [(ngModel)]="searchTermSpeciality" 
                       (input)="applyFilter()" 
                       placeholder="  Rechercher par matricule, médecin, pôle ou salle..."
                       class="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11">
              </span>
            </div>
          </div>

          <div class="table-container overflow-x-auto" style="border-radius: 0.75rem;">
            <p-table [value]="filteredSpeciality" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords" [lazy]="false" (onPage)="onPageChange($event)" [tableStyle]="{ 'min-width': '100%' }" responsiveLayout="scroll" class="w-full">
              <ng-template pTemplate="header">
                <tr>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Matricule</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Nom</th>
                  <th class="p-3 bg-gray-200 border-b" style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Actions</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-specialities>
                <tr class="table-row hover:bg-gray-50">
                  <td class="p-3 border-b">{{ specialities.matricule }}</td>
                  <td class="p-3 border-b">{{ specialities.name }}</td>
                  <td class="space-x-3">
                    <i class="pi pi-pencil cursor-pointer text-blue-500 hover:text-blue-700" (click)="showEditDialogSpeciality(specialities)"></i>
                    <i class="pi pi-trash cursor-pointer text-red-500 hover:text-red-700" (click)="confirmDeleteSpeciality(specialities)"></i>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
          <!--<div class="card flex justify-end mt-5">
            <p-paginator (onPageChange)="onPageChange($event)" [first]="first" [rows]="rows" [totalRecords]="totalRecords" [rowsPerPageOptions]="[10, 20, 30]" />
          </div>-->
        </p-tabPanel>
  </p-tabView>
</div>

<p-dialog header="Confirmation de suppression" [(visible)]="deleteServiceDialog" [style]="{width: '450px'}" [modal]="true">
  <div class="confirmation-content">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    <span>Êtes-vous sûr de vouloir supprimer ce service?</span>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="deleteServiceDialog = false" label="Annuler" styleClass="p-button-secondary"></p-button>
    <p-button icon="pi pi-check" (click)="deleteService()" label="Supprimer" styleClass="p-button-danger"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Confirmation de suppression" [(visible)]="deleteCodeDialog" [style]="{width: '450px'}" [modal]="true">
  <div class="confirmation-content">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    <span>Êtes-vous sûr de vouloir supprimer ce code?</span>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="deleteCodeDialog = false" label="Annuler" styleClass="p-button-secondary"></p-button>
    <p-button icon="pi pi-check" (click)="deleteCode()" label="Supprimer" styleClass="p-button-danger"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Confirmation de suppression" [(visible)]="deleteSpecialityDialog" [style]="{width: '450px'}" [modal]="true">
  <div class="confirmation-content">
    <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
    <span>Êtes-vous sûr de vouloir supprimer cette compétence?</span>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="deleteSpecialityDialog = false" label="Annuler" styleClass="p-button-secondary"></p-button>
    <p-button icon="pi pi-check" (click)="deleteSpeciality()" label="Supprimer" styleClass="p-button-danger"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Upload de fichier Excel" [(visible)]="uploadDialogVisible" [style]="{width: '450px'}" [modal]="true">
  <div class="flex flex-col gap-4">
    <p>Veuillez sélectionner un fichier Excel à uploader pour les {{uploadType}}s</p>
    <p-fileUpload 
      [url]="uploadUrl"
      name="file"
      accept=".xlsx,.xls"
      (onUpload)="onUpload($event)"
      (onBeforeUpload)="onBeforeUpload($event)"
      (onError)="onUploadError($event)"
      maxFileSize="1000000">
      <ng-template pTemplate="content">
        <div *ngIf="uploadProgress > 0" class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-blue-600 h-2.5 rounded-full" [style.width]="uploadProgress + '%'"></div>
        </div>
      </ng-template>
    </p-fileUpload>
  </div>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-times" (click)="uploadDialogVisible = false" label="Annuler" styleClass="p-button-secondary"></p-button>
  </ng-template>
</p-dialog>
